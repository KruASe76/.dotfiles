#!/bin/bash

# ==============================================================================
# Genshin Impact Gacha Link Exporter for Linux (Wine/Proton)
# ==============================================================================

# --- CONFIGURATION ---
# Path to the game installation directory inside your Wine prefix.
# NOTE: Update this path if your installation location differs.
GAME_ROOT="/mnt/ext4/data/games/PortProton/prefixes/HO_YO_PLAY/drive_c/Program Files/HoYoPlay/games/Genshin Impact game"
DATA_DIR="$GAME_ROOT/GenshinImpact_Data"

# Colors for CLI output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "üîç Searching for game cache in: $DATA_DIR"

# 1. Locate the webCaches folder
# Structure: GenshinImpact_Data/webCaches/x.xx.xx.xx/Cache/Cache_Data/data_2
WEB_CACHE_ROOT="$DATA_DIR/webCaches"

if [ ! -d "$WEB_CACHE_ROOT" ]; then
    echo -e "${RED}‚ùå Error: 'webCaches' folder not found!${NC}"
    echo "   Please open the Wish History in-game to generate the cache, then try again."
    exit 1
fi

# Get the latest cache version directory
LATEST_CACHE_VER=$(ls -t "$WEB_CACHE_ROOT" | head -n 1)
CACHE_FILE="$WEB_CACHE_ROOT/$LATEST_CACHE_VER/Cache/Cache_Data/data_2"

if [ ! -f "$CACHE_FILE" ]; then
    echo -e "${RED}‚ùå Error: Cache index file 'data_2' not found at:${NC}"
    echo "   $CACHE_FILE"
    exit 1
fi

echo -e "üìÇ Using cache version: $LATEST_CACHE_VER"
echo -e "üïµÔ∏è  Scanning cache file (this might take a moment)..."

# 2. Extract URLs using strings and grep
# We look for strings starting with https, containing the log endpoint and the biz identifier.
URLS=$(strings "$CACHE_FILE" | grep "https:.*/getGachaLog" | grep "game_biz=")

if [ -z "$URLS" ]; then
    echo -e "${RED}‚ùå No gacha links found within the cache.${NC}"
    echo "   Please open the Wish History in-game and flip a few pages to refresh the log."
    exit 1
fi

# 3. Validate links via the official API
echo "üß™ Validating found tokens..."

IFS=$'\n'
FOUND_WORKING=0

for LINK in $URLS; do
    LINK=${LINK:4}
    # Perform a test request to the API to check if the token is still active.
    # We append minimal parameters to ensure a valid JSON response.

    RESPONSE=$(curl -s "$LINK&size=5&gacha_type=301")

    # Check for "retcode":0 which indicates a successful authorization.
    if echo "$RESPONSE" | grep -q '"retcode":0'; then
        echo -e "${GREEN}‚úÖ Success! Valid link found:${NC}"
        echo "---------------------------------------------------"
        echo "$LINK"
        echo "---------------------------------------------------"

        # Attempt to auto-copy to clipboard
        if command -v wl-copy &> /dev/null; then
            echo -n "$LINK" | wl-copy
            echo -e "${GREEN}üìã Link copied to clipboard (Wayland)!${NC}"
        elif command -v xclip &> /dev/null; then
            echo -n "$LINK" | xclip -selection clipboard
            echo -e "${GREEN}üìã Link copied to clipboard (X11)!${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Clipboard utility not found. Please copy the link manually.${NC}"
        fi

        FOUND_WORKING=1
        break
    fi
done

if [ $FOUND_WORKING -eq 0 ]; then
    echo -e "${RED}‚ö†Ô∏è  Links were found, but they have all expired.${NC}"
    echo "   Tokens expire quickly. Please re-open the Wish History in-game."
fi
